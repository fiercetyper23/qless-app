<!DOCTYPE html>
<html>
<head>
    <title>QLess - Login</title>
    <link rel="stylesheet" href="styles.css">
</head>

<body>
    <!-- Header -->
    <div class="text-center">
        <h1>QLess</h1>
        <p>The Sustainable Way to Makan</p>
    </div>

    <!-- Alert Messages -->
    <div id="alertMessage" style="display: none;"></div>

    <!-- Tab Buttons -->
    <div class="tab-buttons">
        <button class="tab-button active" onclick="showTab('login')">Login</button>
        <button class="tab-button" onclick="showTab('register')">Register</button>
        <button class="tab-button" onclick="showTab('phone')">Phone Login</button>
    </div>

    <!-- Tab Content -->
    <div class="tab-content">
        
        <!-- Login Tab -->
        <div id="login" class="tab-panel active">
            <form id="loginForm" onsubmit="return handleLogin(event)">
                <div class="form-group">
                    <label for="loginEmail">Email:</label>
                    <input type="email" id="loginEmail" required>
                </div>
                <div class="form-group">
                    <label for="loginPassword">Password:</label>
                    <input type="password" id="loginPassword" required>
                </div>
                <button type="submit">
                    <span class="loading" style="display: none;">Logging in...</span>
                    <span class="normal">Login</span>
                </button>
            </form>
        </div>

        <!-- Register Tab -->
        <div id="register" class="tab-panel">
            <form id="registerForm" onsubmit="return handleRegister(event)">
                <div class="form-group">
                    <label for="registerName">Name:</label>
                    <input type="text" id="registerName" required>
                </div>
                <div class="form-group">
                    <label for="registerEmail">Email:</label>
                    <input type="email" id="registerEmail" required>
                </div>
                <div class="form-group">
                    <label for="registerPassword">Password:</label>
                    <input type="password" id="registerPassword" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="confirmPassword">Confirm Password:</label>
                    <input type="password" id="confirmPassword" required>
                </div>
                <button type="submit">
                    <span class="loading" style="display: none;">Creating Account...</span>
                    <span class="normal">Register</span>
                </button>
            </form>
        </div>

        <!-- Phone Login Tab -->
        <div id="phone" class="tab-panel">
            <div id="phoneStep1">
                <form id="phoneForm" onsubmit="return handlePhoneLogin(event)">
                    <div class="form-group">
                        <label for="phoneNumber">Phone Number:</label>
                        <input type="tel" id="phoneNumber" placeholder="+65 9123 4567" required>
                        <small class="text-muted">We'll send you a verification code</small>
                    </div>
                    <button type="submit">
                        <span class="loading" style="display: none;">Sending Code...</span>
                        <span class="normal">Send Verification Code</span>
                    </button>
                </form>
            </div>
            
            <div id="phoneStep2" style="display: none;">
                <form id="verifyForm" onsubmit="return handleVerification(event)">
                    <div class="form-group">
                        <label for="verificationCode">Verification Code:</label>
                        <input type="text" id="verificationCode" placeholder="Enter 6-digit code" maxlength="6" required>
                        <small class="text-muted">Code sent to <span id="sentToNumber"></span></small>
                    </div>
                    <button type="submit">
                        <span class="loading" style="display: none;">Verifying...</span>
                        <span class="normal">Verify & Login</span>
                    </button>
                    <br><br>
                    <button type="button" onclick="resendCode()" class="resend-btn">
                        Resend Code
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Footer -->
    <div class="text-center" style="margin-top: 20px;">
        <small class="text-muted">
            New to QLess? Join us in reducing waste while enjoying great food!
        </small>
    </div>

    <script>
        // API Base URL
        const API_BASE_URL = 'https://djkzzr6w1g.execute-api.us-east-1.amazonaws.com';

        // Tab switching
        function showTab(tabName) {
            const tabs = document.querySelectorAll('.tab-panel');
            tabs.forEach(tab => {
                tab.classList.remove('active');
            });
            
            const buttons = document.querySelectorAll('.tab-button');
            buttons.forEach(button => {
                button.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            event.target.classList.add('active');
        }

        // Email/Password Login
        function handleLogin(event) {
            event.preventDefault();
            
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            
            if (!email || !password) {
                showAlert('Please fill in all fields', 'danger');
                return false;
            }

            showLoading('login');
            loginWithEmail(email, password);
            return false;
        }

        async function loginWithEmail(email, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        email: email,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.message === "Login successful") {
                    sessionStorage.setItem("user_id", result.user_id);
                    
                    hideLoading('login');
                    showAlert('Login successful! Redirecting...', 'success');
                    setTimeout(() => {
                        window.location.href = 'main.html'; // Change to your main app page
                    }, 1500);
                } else {
                    hideLoading('login');
                    showAlert('Invalid email or password', 'danger');
                }
            } catch (error) {
                hideLoading('login');
                showAlert('Login failed. Please try again.', 'danger');
                console.error('Login error:', error);
            }
        }

        // Registration
        function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('registerName').value;
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            
            if (!name || !email || !password || !confirmPassword) {
                showAlert('Please fill in all fields', 'danger');
                return false;
            }

            if (password !== confirmPassword) {
                showAlert('Passwords do not match', 'danger');
                return false;
            }

            if (password.length < 6) {
                showAlert('Password must be at least 6 characters long', 'danger');
                return false;
            }

            showLoading('register');
            registerUser(name, email, password);
            return false;
        }

        async function registerUser(name, email, password) {
            try {
                const response = await fetch(`${API_BASE_URL}/api/users-register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        name: name,
                        email: email,
                        password: password
                    })
                });
                
                const result = await response.json();
                
                if (response.ok && result.message === "User registered") {
                    hideLoading('register');
                    showAlert('Account created successfully! Please login.', 'success');
                    
                    showTab('login');
                    document.getElementById('loginEmail').value = email;
                } else {
                    hideLoading('register');
                    showAlert('Registration failed. Email may already exist.', 'danger');
                }
            } catch (error) {
                hideLoading('register');
                showAlert('Registration failed. Please try again.', 'danger');
                console.error('Registration error:', error);
            }
        }

        // Phone Login (Demo - Replace with AWS Cognito later)
        function handlePhoneLogin(event) {
            event.preventDefault();
            
            const phoneNumber = document.getElementById('phoneNumber').value;
            
            if (!phoneNumber) {
                showAlert('Please enter your phone number', 'danger');
                return false;
            }

            // Basic phone number validation
            const phoneRegex = /^[\+]?[1-9][\d]{0,15}$/;
            if (!phoneRegex.test(phoneNumber.replace(/\s/g, ''))) {
                showAlert('Please enter a valid phone number', 'danger');
                return false;
            }

            showLoading('phone');
            
            // Demo phone verification - replace with AWS Cognito SMS
            setTimeout(() => {
                hideLoading('phone');
                document.getElementById('phoneStep1').style.display = 'none';
                document.getElementById('phoneStep2').style.display = 'block';
                document.getElementById('sentToNumber').textContent = phoneNumber;
                showAlert('Verification code sent! Use 123456 for demo.', 'info');
            }, 2000);
            
            return false;
        }

        function handleVerification(event) {
            event.preventDefault();
            
            const verificationCode = document.getElementById('verificationCode').value;
            
            if (!verificationCode || verificationCode.length !== 6) {
                showAlert('Please enter the 6-digit verification code', 'danger');
                return false;
            }

            showLoading('verify');
            
            // Demo verification - replace with AWS Cognito verification
            setTimeout(() => {
                hideLoading('verify');
                if (verificationCode === '123456') {
                    showAlert('Phone verification successful! Welcome to QLess!', 'success');
                    
                    // For demo, create a session
                    sessionStorage.setItem("user_id", "PHONE_USER_" + Date.now());
                    
                    setTimeout(() => {
                        window.location.href = 'main.html'; // Change to your main app page
                    }, 1500);
                } else {
                    showAlert('Invalid verification code. Use 123456 for demo.', 'danger');
                }
            }, 1500);
            
            return false;
        }

        function resendCode() {
            const phoneNumber = document.getElementById('phoneNumber').value;
            showAlert(`New code sent to ${phoneNumber} (Demo - Use 123456)`, 'info');
        }

        // Utility Functions
        function showAlert(message, type) {
            const alertDiv = document.getElementById('alertMessage');
            alertDiv.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            alertDiv.style.display = 'block';
            
            setTimeout(() => {
                alertDiv.style.display = 'none';
            }, 5000);
        }

        function showLoading(formType) {
            const form = document.getElementById(formType + 'Form');
            const loadingSpan = form.querySelector('.loading');
            const normalSpan = form.querySelector('.normal');
            
            if (loadingSpan && normalSpan) {
                loadingSpan.style.display = 'inline';
                normalSpan.style.display = 'none';
            }
        }

        function hideLoading(formType) {
            const form = document.getElementById(formType + 'Form');
            const loadingSpan = form.querySelector('.loading');
            const normalSpan = form.querySelector('.normal');
            
            if (loadingSpan && normalSpan) {
                loadingSpan.style.display = 'none';
                normalSpan.style.display = 'inline';
            }
        }

        // Check if already logged in
        window.addEventListener('load', function() {
            const userId = sessionStorage.getItem("user_id");
            if (userId) {
                window.location.href = 'main.html'; // Change to your main app page
            }
        });
    </script>
</body>
</html>